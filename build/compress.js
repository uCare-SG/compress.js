(function(global,factory){if(typeof define==='function'&&define.amd){define(['module','./core/base64.js','./core/converter.js','./core/file.js','./core/image.js','./core/photo.js','./core/rotate.js'],factory)}else if(typeof exports!=='undefined'){factory(module,require('./core/base64.js'),require('./core/converter.js'),require('./core/file.js'),require('./core/image.js'),require('./core/photo.js'),require('./core/rotate.js'))}else{var mod={exports:{}};factory(mod,global.base64,global.converter,global.file,global.image,global.photo,global.rotate);global.compress=mod.exports}})(this,function(module,_base,_converter,_file,_image,_photo,_rotate){'use strict';var _base2=_interopRequireDefault(_base);var _converter2=_interopRequireDefault(_converter);var _file2=_interopRequireDefault(_file);var _image2=_interopRequireDefault(_image);var _photo2=_interopRequireDefault(_photo);var _rotate2=_interopRequireDefault(_rotate);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++)arr2[i]=arr[i];return arr2}return Array.from(arr)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError('Cannot call a class as a function')}var _createClass=function(){function defineProperties(target,props){for(var descriptor,i=0;i<props.length;i++)descriptor=props[i],descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,'value'in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}();var Compress=function(){function Compress(){_classCallCheck(this,Compress)}return _createClass(Compress,[{key:'attach',value:function attach(a,b){var _this=this;return new Promise(function(c){var e=document.querySelector(a);e.setAttribute('accept','image/*'),e.addEventListener('change',function(f){var g=_this.compress([].concat(_toConsumableArray(f.target.files)),b);c(g)},!1)})}},{key:'compress',value:function compress(a,b){function c(f,g){var h=new _photo2.default(g);return h.start=window.performance.now(),h.alt=f.name,h.ext=f.type,h.startSize=f.size,_rotate2.default.orientation(f).then(function(i){return h.orientation=i,_file2.default.load(f)}).then(d(h))}function d(f){return function(g){return _image2.default.load(g).then(function(h){if(f.startWidth=h.naturalWidth,f.startHeight=h.naturalHeight,f.resize){var _Image$resize=_image2.default.resize(f.maxWidth,f.maxHeight)(h.naturalWidth,h.naturalHeight),i=_Image$resize.width,j=_Image$resize.height;f.endWidth=i,f.endHeight=j}else f.endWidth=h.naturalWidth,f.endHeight=h.naturalHeight;return _converter2.default.imageToCanvas(f.endWidth,f.endHeight,f.orientation)(h)}).then(function(h){return f.iterations=1,f.base64prefix=_base2.default.prefix(f.ext),e(h,f.startSize,f.quality,f.size,f.minQuality,f.iterations)}).then(function(h){return f.finalSize=_base2.default.size(h),_base2.default.data(h)}).then(function(h){f.end=window.performance.now();var i=f.end-f.start;return{data:h,prefix:f.base64prefix,elapsedTimeInSeconds:i/1e3,alt:f.alt,initialSizeInMb:_converter2.default.size(f.startSize).MB,endSizeInMb:_converter2.default.size(f.finalSize).MB,ext:f.ext,quality:f.quality,endWidthInPx:f.endWidth,endHeightInPx:f.endHeight,initialWidthInPx:f.startWidth,initialHeightInPx:f.startHeight,sizeReducedInPercent:100*((f.startSize-f.finalSize)/f.startSize),iterations:f.iterations}})}}function e(f){var h=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1,j=4<arguments.length&&void 0!==arguments[4]?arguments[4]:1,i=arguments[3],k=arguments[5],l=_converter2.default.canvasToBase64(f,h),m=_base2.default.size(l);return k+=1,m>i?e(f,m,h-0.1,i,j,k):h>j?e(f,m,h-0.1,i,j,k):0.5>h?l:l}return Promise.all(a.map(function(f){return c(f,b)}))}}],[{key:'convertBase64ToFile',value:function convertBase64ToFile(a,b){return _converter2.default.base64ToFile(a,b)}}]),Compress}();module.exports=Compress});
